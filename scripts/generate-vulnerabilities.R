# make dataframe of probability of loss or gain/neutrality
# for each site and exposure factor combination(s)
# including for 'high' to 'low' score

library(QPress)
library(tidyverse)
library(ggplot2)
library(ggh4x)
source('scripts/helpers/helpers.R')
source('scripts/helpers/models.R')

# set up vulnerability scenarios for model
#sed <- expand.grid(site_char = 'Sediment', score = c('Low', 'High')) %>% mutate(site_char = paste0(.$site_char, '_', .$score))
#tide <- expand.grid(site_char = 'TidalRange', score = c('Micro', 'Meso', 'Macro')) %>% mutate(site_char = paste0(.$site_char, '_', .$score))
#squeeze <- data.frame(expand.grid(site_char = 'CoastalSqueeze', score = c('Low', 'Medium', 'High'))) %>% mutate(site_char = paste0(.$site_char, '_', .$score)) # this is coastal squeeze

# expand grid for site (high, med, low) by exposure (high, medium, low) pressure combinations 
shore_change <- expand.grid(site_char = c('Erosion', 'CoastalDev'), score = c('0.25', '0.5', '0.75')) # this is erosion
site_characteristics <- shore_change %>% mutate(site_char = paste0(.$site_char, '_', .$score))
exposure <- expand.grid(site_char = c('ExtremeRainfall', 'Drought', 'Cyclones', 'SeaLevelRise'), score = c('0.25', '0.5', '0.75'))
exp_characteristics <- exposure %>% mutate(site_char = paste0(.$site_char, '_', .$score))
combo <- expand.grid(site = site_characteristics$site_char, exposure = exp_characteristics$site_char)

# run model and extract probabilities for all combinations of site and exposure
# loop through settings: sediment supply, coastal squeeze, tidal range
# make the probability of site char/exposure = low medium or high

set.seed(123)
numsims <- 1000
chosen_model <- models[[1]] # choose the primary model

# define edge constraints - whether edge interaction strengths should be 'high', 'medium' or 'low'
edge.labels(chosen_model) # get model edges for reference
# create a grid of all combinations of high, medium and low for tidal range, propagule establishment capacity and coastal squeeze
edge.cons.grid <- expand.grid(TidalRange = c('H', 'M', 'L'),
                              PropEstab = c('H', 'M', 'L'),
                              CoastalSqueeze = c('H', 'M', 'L'))
# turn into a list
edge.cons.scenarios <- as.list(as.data.frame(t(edge.cons.grid)))
# label the list
labels.grid <- expand.grid(TidalRange = c('Microtidal', 'Mesotidal', 'Macrotidal'),
                           PropEstab = c('High', 'Medium', 'Low'),
                           CoastalSqueeze = c('Low', 'Medium', 'High')) # note that a low value for the interaction strength = High coastal squeeze and vice-versa
names(edge.cons.scenarios) <- apply(labels.grid, 1, function(row) paste(row, collapse = "_")) # label the list of edge constraint scenarios
# in each list element, repeat the middle character
edge.cons.scenarios <- lapply(edge.cons.scenarios, function(x) c(x[c(1,2)], x[2], x[3]))
# for each scenario, set up 'from' 'to' vectors specifying edges they apply to
from_vec <-  c('SeaLevelRise','LandwardAvailableProp', 'SeawardAvailableProp', 'SeaLevelRise')
to_vec <- c('SeawardMang', 'LandwardMang', 'SeawardMang', 'LandwardMang')
  
# define relative edge constraints - which edge interaction strengths are greater than other
# in all models the seaward mangrove -> substrate vol interaction strength is greater than the landward mangrove -> substrate vol interaction strength
# under a high sediment supply scenario, the sediment -> subVol interaction strengths will be greater than
# the negative interaction between sea level rise -* and seaward mangroves; vice versa for the low sediment supply model
rel.edge.cons.scenarios <- list(parse.constraints(c('SeaLevelRise -* SeawardMang < Sediment -> SubVol', 'LandwardMang -> SubVol < SeawardMang -> SubVol'), chosen_model),
                                parse.constraints(c('Sediment -> SubVol < SeaLevelRise -* SeawardMang', 'LandwardMang -> SubVol < SeawardMang -> SubVol'), chosen_model))
names(rel.edge.cons.scenarios) <- c('High', 'Low') # label the list of relative edge constraint scenarios 
  
# loop through site-exposure scenarios defined above and store model outcomes
# do a nested for loop, iterate over relative edge constraint scenarios, absolute edge constraint scenarios, then perturbation scenarios
  
outcomes.ls1 <- list() # list for storing model outcome results
system.time(
    for(k in seq_along(rel.edge.cons.scenarios)){
      outcomes.ls <- list()
      model <- rel.edge.cons.scenarios[[k]]
      for(j in seq_along(edge.cons.scenarios)){
        out <- list()
        class.con <- edge.cons.scenarios[[j]]
        for(i in 1:nrow(combo)){
          pressure <- c(1,1) # site and exposure combination
          names(pressure) <- c(sub('_.*', '', combo[i,1]), sub('_.*', '', combo[i,2]))
          sim <- system.sim_press(numsims, constrainedigraph = model, 
                                  from = from_vec,
                                  to = to_vec,
                                  class = class.con,
                                  perturb = pressure,
                                  spatial = 'Y', # just put yes so we allow for coastal squeeze regardless of whether coastal dev is a pressure
                                  arid = 'N',
                                  score = as.numeric(c(sub('.*_', '', combo[i,1]), sub('.*_', '', combo[i,2]))), # score for first site characteristic, score for exposure factor
                                  prob = c(0.1, 0.5)) # here assume probability of propagule establishment is 50% in all environments, and only 10% for landward propagules in arid environments
          out[[i]] <- data.frame(sim$stableoutcome, site = sub('_.*', '', combo[i,1]), exposure = sub('_.*', '', combo[i,2]),
                                 site_score = as.numeric(c(sub('.*_', '', combo[i,1]))),  exposure_score = as.numeric(c(sub('.*_', '', combo[i,2]))),
                                 sediment = names(rel.edge.cons.scenarios)[k], setting = names(edge.cons.scenarios)[j])
        } # end i loop
        # outcomes
        outcomes.ls[[j]] <- do.call(rbind, out)
      } # end j loop
      # outcomes
      outcomes.ls1[[k]] <- do.call(rbind, outcomes.ls)
    } # end k loop
  )
  
# save outcomes
outcomes <- do.call(rbind, outcomes.ls1) %>% filter(var %in% c('LandwardMang','SeawardMang')) %>% 
  mutate(outcome = ifelse(outcome <0, 0, 1)) %>% 
  group_by(var, site, exposure, site_score, exposure_score, sediment, setting) %>% 
  summarise(Probability_gain_neutral = sum(outcome)/numsims) %>% 
  mutate(tide = sapply(str_split(setting, '_'), '[', 1),
         ecological_connectivity = sapply(str_split(setting, '_'), '[', 2),
         coastal_squeeze = sapply(str_split(setting, '_'), '[', 3))

saveRDS(outcomes, 'data/outcomes.rds')

# plot

dat <- readRDS('data/outcomes.rds') %>% mutate(Probability_gain_neutral = Probability_gain_neutral*100) %>% 
  filter(ecological_connectivity == 'Medium') %>% mutate_at(vars(site_score, exposure_score), ~case_when(. == 0.25~'Low', . == 0.5 ~ 'Medium', . == 0.75 ~ 'High')) %>% 
  mutate(var = recode(var, LandwardMang = 'Relief (high)', SeawardMang = 'Relief (Low)')) %>% 
  filter(exposure == 'Cyclones') %>% 
  mutate_at(vars(exposure_score, site_score), ~factor(., levels = c('Low', 'Medium', 'High')))

a <- ggplot(dat, 
            aes(factor(site_score), factor(exposure_score), fill = Probability_gain_neutral)) +
  geom_tile(color = 'black') +
  scale_fill_distiller(palette = 'Spectral', 
                       name = 'Probability of Loss (red) or Gain/Neutrality (blue)',
                       direction = 1,
                       breaks = c(0, 25, 50, 75, 100),
                       limits = c(0,100),
                       labels = c("-100", "-75", "50", '75', '100')) +
  facet_nested(~factor(exposure) + factor(var) + factor(sediment) + factor(tide) + factor(coastal_squeeze)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  theme_classic() +
  theme(legend.position = 'bottom',
        legend.justification = 'left',
        strip.text.x = element_text(size = 9),
        title = element_text(size = 8),
        axis.title = element_blank()) +
  guides(fill = guide_colourbar(title.position="top", title.hjust = 0.5))
a


